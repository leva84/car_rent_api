# Тестовое задание
Разработка идемпотентного API для управления арендой автомобилей.

##### Цель задания:
Разработать идемпотентные RESTful API-методы на Ruby on Rails, которые позволят начинать и завершать аренду автомобиля. Аренда должна инициироваться и заканчиваться безопасно, даже если в процессе возникают повторные запросы (из-за сетевых ошибок, повторных нажатий пользователя и т.д.).

##### Требования к заданию:
1. **Проектирование методов API:** API должен содержать два метода: один для начала аренды `start_rental` и другой для её завершения `end_rental`.
2. **Идентификация и обработка идемпотентных запросов:** Реализовать механизм, который позволит идентифицировать повторные запросы. Например, использовать токен идемпотентности, передаваемый клиентом. Если система обнаруживает повторный запрос с тем же токеном, она должна возвращать результат предыдущего запроса, не выполняя операцию заново.
3. **Обеспечение консистентности данных:** Разработать решение, которое гарантирует, что даже в случае повторных запросов состояние системы остается консистентным. Например, аренда не может быть начата заново, если она уже активна.
4. **Логирование и отладка:** Включить механизмы логирования для отслеживания идемпотентных запросов и действий, выполняемых API.

##### Дополнительные задания:
* Предложить гипотетические способы оптимизации и масштабирования системы для обработки высокой нагрузки, например, при массовом начале и завершении аренд в пиковые периоды.
* Рассмотреть варианты обработки исключительных ситуаций, например, когда состояние автомобиля не позволяет начать или завершить аренду (автомобиль заблокирован, неисправен и т.п.).

##### Критерии оценки:
* Корректность реализации идемпотентности.
* Эффективность обработки повторных запросов.
* Чистота и читаемость кода.
* Учет возможных ошибок и исключительных ситуаций.
* Подходы к обеспечению масштабируемости и устойчивости к высоким нагрузкам.

### Реализация
1. Реализован минимальный функционал API, который включает в себя два эндпоинта:
    ```
    http://host_name/start_rental
    http://host_name/end_rental
    ```
   Параметры запроса для эндпоинтов одинаковы - user_id и car_id.
   Такой подход обусловлен отсутствием аутентификации и авторизации пользователей.
2. Идентификация и обработка идемпотентных запросов реализована через проверку существования аренды.
   Логика следующая: если аренда открыта, то при повторной попытке открытия, клиенту вернется результат с открытой арендой.
   Если аренда закрыта, то пользователь получит ответ о том `ok`, как и при первичном закрытии аренды.
3. Обеспечение консистентности данных достигнуто за счет проведения операций открытия и закрытия аренды
   в рамках общей транзакции.
4. При попытке повторного открытия аренды действие логируется с уровнем логирования `warn`.

### Дополнительные задания
* Масштабируемость достигнута за счет выноса логики открытия/закрытия аренды авто в отдельный сервис.
* Варианты обработки исключительных ситуаций реализованы частично, есть проверка на состояние автомобиля через его статус.
  Можно улучшать в зависимости от того, как будет реализован функционал получения данных автомобиля.
* Реализована оптимизация под высокую нагрузку. Добавлен составной индекс в таблицу аренды,
  для быстрого поиска по параметрам запроса. Так же в проект добавлен Redis, в который производится запись первичных операций.
  Если операция повторяется, то пользователь получает идемптентный ответ относительно повторной операции.

### Развертывание и тестирование
Проект настроен для развертывания с помощью `Docker`. Поэтому перед началом необходимо его установить.

* Клонировать репозиторий.
  ```
    git clone git@github.com:leva84/car_rent_api.git
  ```

* Перейти в директорию проекта.
  ```
    cd car_rent_api
  ```

* Установить необходимые образы.
  ```
    docker-compose up
  ```

* Прогнать миграции и создать данные в БД.
  ```
    docker-compose run --rm web bin/rails db:create db:migrate db:seed
  ```

* Запустить API.
  ```
    docker-compose up web
  ```

* Протестировать работу эндпоинтов с помощью `curl`, например:
  ```
    curl -X POST http://0.0.0.0:3000/start_rental -d "user_id=1&car_id=3"
    curl -X DELETE http://0.0.0.0:3000/end_rental -d "user_id=2&car_id=3"
  ```

* Протестировать работу API с помощью спецификаций.
  ```
    docker-compose run --rm test
  ```
